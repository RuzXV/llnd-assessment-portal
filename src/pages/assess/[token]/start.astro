---
import Layout from '../../../layouts/Layout.astro';
import AssessmentPlayer from '../../../components/student/AssessmentPlayer.svelte';

const { token } = Astro.params;
const url = new URL(Astro.request.url);
const apiUrl = `${url.origin}/api/assessments/${token}`;

let assessmentData = null;
let error = null;

try {
  const res = await fetch(apiUrl);
  if (!res.ok) {
    error = 'Unable to load assessment.';
  } else {
    assessmentData = await res.json();
  }
} catch (e) {
  error = 'System Error';
}

if (error || !assessmentData) {
  return Astro.redirect(`/assess/${token}`);
}
---

<Layout title="Assessment In Progress">
  <main class="min-h-screen bg-gray-50 dark:bg-slate-900 flex flex-col relative overflow-hidden">
    
    <div class="absolute top-0 left-0 w-full h-1 bg-gray-200 dark:bg-gray-800 z-50">
        </div>

    <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500/5 rounded-full blur-3xl translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>

    <div class="flex-1 max-w-3xl w-full mx-auto p-4 md:p-6 relative z-10 flex flex-col justify-center">
      <AssessmentPlayer client:load data={assessmentData} token={token} />
    </div>

  </main>
</Layout>