---
import Layout from '../../layouts/Layout.astro';
import AssessmentIntro from '../../components/student/AssessmentIntro.svelte';

const { token } = Astro.params;

// 1. Fetch Assessment Data Server-Side
const url = new URL(Astro.request.url);
const apiUrl = `${url.origin}/api/assessments/${token}`;

let assessmentData = null;
let error = null;

try {
  const res = await fetch(apiUrl);
  if (!res.ok) {
    const err: any = await res.json();
    error = err.error || 'Invalid Link';
  } else {
    assessmentData = await res.json();
  }
} catch (e) {
  error = 'System Error or Invalid Token';
}
---

<Layout title="Student Assessment">
  <main class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
    
    <div class="absolute inset-0 bg-gray-50 dark:bg-slate-900 -z-10"></div>
    <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl translate-x-1/2 -translate-y-1/2"></div>
    
    <div class="w-full max-w-2xl relative z-10">
      
      {error ? (
        <div class="glass-panel-fixed p-8 rounded-xl text-center max-w-md mx-auto">
           <div class="mb-4 inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-100 text-red-600">
             <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
           </div>
           <h1 class="text-xl font-bold text-white mb-2">Access Denied</h1>
           <p class="text-slate-300">{error}</p>
           <p class="text-sm text-slate-400 mt-4">Please contact your training provider for a new link.</p>
        </div>
      ) : (
        <AssessmentIntro client:load data={assessmentData} token={token} />
      )}

    </div>
  </main>
</Layout>