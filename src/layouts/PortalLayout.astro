---
import Layout from './Layout.astro';

interface SidebarItem {
  label: string;
  href: string;
  icon?: string;
}

interface Props {
  title: string;
  portalName: string;
  portalColor?: string; // 'blue' | 'green' | 'purple' | 'amber'
  sidebarItems?: SidebarItem[];
}

const { title, portalName, portalColor = 'blue', sidebarItems = [] } = Astro.props;
const currentPath = Astro.url.pathname;

const colorMap: Record<string, { bg: string; text: string; border: string; activeBg: string }> = {
  blue: { bg: 'bg-blue-600/20 dark:bg-blue-400/20', text: 'text-blue-600 dark:text-blue-400', border: 'border-blue-500/30', activeBg: 'bg-blue-600/10' },
  green: { bg: 'bg-green-600/20 dark:bg-green-400/20', text: 'text-green-600 dark:text-green-400', border: 'border-green-500/30', activeBg: 'bg-green-600/10' },
  purple: { bg: 'bg-purple-600/20 dark:bg-purple-400/20', text: 'text-purple-600 dark:text-purple-400', border: 'border-purple-500/30', activeBg: 'bg-purple-600/10' },
  amber: { bg: 'bg-amber-600/20 dark:bg-amber-400/20', text: 'text-amber-600 dark:text-amber-400', border: 'border-amber-500/30', activeBg: 'bg-amber-600/10' },
};
const colors = colorMap[portalColor] || colorMap.blue;
---

<Layout title={title}>
  <div class="min-h-screen relative">
    <!-- Authenticated Top Nav -->
    <nav class="sticky top-0 z-50 glass-nav">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
          <div class="flex items-center space-x-3">
            <a href="/" class="flex items-center space-x-3 no-underline">
              <div class={`h-8 w-8 ${colors.bg} border ${colors.border} rounded flex items-center justify-center`}>
                <svg class={`h-5 w-5 ${colors.text}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
              </div>
              <span class="font-bold text-xl tracking-tight text-slate-800 dark:text-white">EduX</span>
            </a>
            <span class="text-slate-400 dark:text-slate-500 hidden sm:inline">/</span>
            <span class={`text-sm font-medium ${colors.text} hidden sm:inline`}>{portalName}</span>
          </div>

          <!-- Auth Nav Links (center) -->
          <div class="hidden md:flex items-center space-x-1">
            <a href="/" class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 transition-colors no-underline">Home</a>

            <!-- Portals dropdown -->
            <div class="relative group">
              <button class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 transition-colors flex items-center space-x-1">
                <span>Portals</span>
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
              </button>
              <div class="absolute top-full left-0 mt-1 w-56 glass-panel rounded-xl shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 py-2">
                <a href="/portal/llnd" class="block px-4 py-2.5 text-sm text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 no-underline">LLND Portal</a>
                <a href="/portal/per" class="block px-4 py-2.5 text-sm text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 no-underline">PER Portal</a>
                <a href="/portal/qa" class="block px-4 py-2.5 text-sm text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 no-underline">Student Data & QA</a>
                <a href="/portal/induction" class="block px-4 py-2.5 text-sm text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 no-underline">Learning - Induction</a>
                <a href="/portal/pd" class="block px-4 py-2.5 text-sm text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 no-underline">Learning - PD</a>
              </div>
            </div>

            <a href="/pd-programs" class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 transition-colors no-underline">PD Programs</a>
            <a href="/account" class="px-3 py-2 rounded-lg text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10 transition-colors no-underline">Account</a>
          </div>

          <div class="flex items-center space-x-4">
            <button id="portal-theme-toggle" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
              <svg id="portal-sun-icon" class="hidden w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h1a1 1 0 100 2h-1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0V16a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
              <svg id="portal-moon-icon" class="hidden w-5 h-5 text-blue-300" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>

            <span class="text-sm font-medium text-slate-700 dark:text-slate-200 hidden sm:block" id="portal-user-display">Loading...</span>
            <button id="portal-logout-btn" class="text-xs font-bold uppercase tracking-wide bg-red-500/80 hover:bg-red-500 text-white px-4 py-2 rounded-lg transition-all backdrop-blur-sm">
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main content area with optional sidebar -->
    <div class="max-w-7xl mx-auto relative z-10">
      {sidebarItems.length > 0 ? (
        <div class="flex">
          <!-- Sidebar -->
          <aside class="hidden md:block w-64 shrink-0 border-r border-white/10 min-h-[calc(100vh-4rem)]">
            <nav class="p-4 space-y-1 sticky top-20">
              {sidebarItems.map((item) => (
                <a
                  href={item.href}
                  class={`flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-colors no-underline ${
                    currentPath === item.href
                      ? `${colors.activeBg} ${colors.text}`
                      : 'text-slate-600 dark:text-slate-300 hover:bg-black/5 dark:hover:bg-white/10'
                  }`}
                >
                  {item.label}
                </a>
              ))}
            </nav>
          </aside>

          <!-- Content -->
          <main class="flex-1 py-8 px-4 sm:px-6 lg:px-8">
            <slot />
          </main>
        </div>
      ) : (
        <main class="py-8 px-4 sm:px-6 lg:px-8">
          <slot />
        </main>
      )}
    </div>
  </div>
</Layout>

<script>
  // Auth check
  const token = localStorage.getItem('llnd_token');
  const userStr = localStorage.getItem('llnd_user');

  if (!token) {
    window.location.href = '/login';
  } else if (userStr) {
    try {
      const user = JSON.parse(userStr);
      const display = document.getElementById('portal-user-display');
      if (display) display.textContent = user.email || 'Admin';
    } catch(e) {}
  }

  // Logout
  document.getElementById('portal-logout-btn')?.addEventListener('click', () => {
    localStorage.removeItem('llnd_token');
    localStorage.removeItem('llnd_user');
    window.location.href = '/login';
  });

  // Theme toggle
  const toggleBtn = document.getElementById('portal-theme-toggle');
  const sunIcon = document.getElementById('portal-sun-icon');
  const moonIcon = document.getElementById('portal-moon-icon');

  function updateIcons() {
    const isDark = document.documentElement.classList.contains('dark');
    if (isDark) {
      sunIcon?.classList.remove('hidden');
      moonIcon?.classList.add('hidden');
    } else {
      sunIcon?.classList.add('hidden');
      moonIcon?.classList.remove('hidden');
    }
  }
  updateIcons();

  toggleBtn?.addEventListener('click', () => {
    const html = document.documentElement;
    html.classList.toggle('dark');
    localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
    updateIcons();
  });
</script>
